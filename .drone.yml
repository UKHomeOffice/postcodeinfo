---
kind: pipeline
type: kubernetes
name: default

steps:

- name: test
  image: python
  commands:
    #- /bin/bash ./scripts/test.sh
  when:
    branch: [master, development, feature/*]
    event: push

- name: build-image
  image: docker:dind
  commands:
    - n=0; while [ "$n" -lt 60 ] && [ ! -e /var/run/docker.sock ]; do n=$(( n + 1 )); sleep 1; done
    - docker build -t hof/postcodeinfo:$${DRONE_COMMIT_SHA} .
  volumes:
    - name: dockersock
      path: /var/run
    - name: nginx
      path: /var/log/nginx
    - name: gunicorn
      path: /var/log/gunicorn
  when:
    branch: [master, development, feature/*]
    event: push

- name: create-artefact
  image: docker:dind
  environment:
    DOCKER_PASSWORD:
      from_secret: docker_password
  commands:
    - docker login -u="ukhomeofficedigital+sas_fbis_robot" -p=$${DOCKER_PASSWORD} quay.io
    - docker tag hof/postcodeinfo:${DRONE_COMMIT_SHA} quay.io/ukhomeofficedigital/postcodeinfo:${DRONE_COMMIT_SHA}
    - docker push quay.io/ukhomeofficedigital/postcodeinfo:${DRONE_COMMIT_SHA}
  volumes:
    - name: dockersock
      path: /var/run
  when:
    branch: [ master, development, feature/* ]
    event: push

- name: deploy-to-dev
  image: quay.io/ukhomeofficedigital/kd:v1.14.0
  commands:
    - export KUBE_TOKEN=$${KUBE_TOKEN_NOTPROD}
    - kd --insecure-skip-tls-verify -f kube/dev/ingress-internal.yaml -f kube/networkpolicy-internal.yaml -f kube/service.yaml
    - kd --insecure-skip-tls-verify --timeout 4m --check-interval 10s -f kube/dev/deployment.yaml
  environment:
    KUBE_NAMESPACE: postcodeinfo-dev
    KUBE_SERVER: https://kube-api-notprod.notprod.acp.homeoffice.gov.uk
    KUBE_TOKEN_NOTPROD:
      from_secret: kube_token_notprod
  when:
    branch: [ master, development, feature/* ]
    event: push

- name: deploy-to-prod
  image: docker:dind
  commands:
  -
  environment:
    KUBE_NAMESPACE: postcodeinfo
    KUBE_SERVER: https://kube-api-prod.prod.acp.homeoffice.gov.uk
    KUBE_TOKEN_PROD:
      from_secret: kube_token_postcodeinfo_acp_prod
  when:
    event: promote
    target: PROD

services:
  - name: docker
    image: docker:dind
    volumes:
      - name: dockersock
        path: /var/run

volumes:
  - name: dockersock
    temp: {}

...
